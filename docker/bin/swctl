#!/usr/bin/env sh
#
# 'swctl' is a POSIX shell script meant to automate certain parts of the Shopware deployment tasks, especially those
# required by the Docker image itself.

# shellcheck disable=SC3040
set -o errexit -o nounset -o pipefail

# shellcheck source=docker/lib/utils.sh
. /usr/local/lib/utils.sh

# ----------------------
#   'help' usage function
# ----------------------
ctl_usage() {
	echo
	echo "Usage: $(basename "${0}") <COMMAND>"
	echo
	echo "init    - Initialize the Shopware instance"
	echo "start   - Start the supervisord process"
	echo "run     - Run Shopware (initialize & start)"
	echo "help    - Print this usage information"
	echo
}

# ----------------------
#   'init' function
# ----------------------

# Wait for the Redis, MySQL and ElasticSearch connections to become available since
# we cannot install anything without them. Afterwards run Shopware's deployment helper
ctl_init() {
	database_connection_check
	redis_connection_check
	elasticsearch_connection_check
	deployment_helper
	log "Completed pre-deployment checks!"
}

# ----------------------
#   'start' function
# ----------------------
ctl_start() {
	log "Starting PHP-FPM..."
	/usr/local/sbin/php-fpm -F
}

# --------------------------------
#   MAIN
# --------------------------------
main() {
	cmd=${1}

	case "${cmd}" in
	init)
		ctl_init
		return $?
		;;
	start)
		ctl_start
		return $?
		;;
	run)
		ctl_init
		ctl_start
		return $?
		;;
	*)
		log "Unknown command: ${cmd}. See 'help' command for usage information:"
		ctl_usage
		return 1
		;;
	esac
}

# ------------
# 'main' call
# ------------
main "$@"
